# notebooks API ãƒ†ã‚¹ãƒˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

## ğŸ“‹ æ¦‚è¦

ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¯ã€notebooks APIã®åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

- **ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: Vitest
- **ã‚«ãƒãƒ¬ãƒƒã‚¸**: GET, POST, PUT, DELETE ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- **ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ—**: æ­£å¸¸ç³»ã€ç•°å¸¸ç³»ã€ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹

---

## ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
tests/
â”œâ”€â”€ helpers/
â”‚   â””â”€â”€ api.helper.ts          # APIãƒ†ã‚¹ãƒˆç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
â”œâ”€â”€ factories/
â”‚   â””â”€â”€ notebook.factory.ts    # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼
â”œâ”€â”€ mocks/
â”‚   â”œâ”€â”€ auth.mock.ts           # èªè¨¼ãƒ¢ãƒƒã‚¯
â”‚   â””â”€â”€ noteService.mock.ts    # noteServiceãƒ¢ãƒƒã‚¯
â””â”€â”€ integration/
    â””â”€â”€ api/
        â””â”€â”€ notebooks/
            â”œâ”€â”€ route.test.ts          # GET /api/notebooks, POST /api/notebooks
            â””â”€â”€ [id]/
                â””â”€â”€ route.test.ts      # GET/PUT/DELETE /api/notebooks/[id]
```

---

## ğŸš€ ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

### ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
```bash
npm run test
```

### ç‰¹å®šã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œ
```bash
npm run test tests/integration/api/notebooks/route.test.ts
```

### Watchãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œï¼ˆé–‹ç™ºä¸­ï¼‰
```bash
npm run test:watch
```

### ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
```bash
npm run test:coverage
```

---

## ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸

### /api/notebooks (route.ts)

**GET /api/notebooks** - ãƒãƒ¼ãƒˆä¸€è¦§å–å¾—
- âœ… æ­£å¸¸ç³»: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒãƒ¼ãƒˆä¸€è¦§ã‚’è¿”ã™
- âœ… æ­£å¸¸ç³»: ãƒãƒ¼ãƒˆãŒ0ä»¶ã®å ´åˆã¯ç©ºé…åˆ—ã‚’è¿”ã™
- âœ… ç•°å¸¸ç³»: æœªèªè¨¼ã®å ´åˆã¯401ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
- âœ… ç•°å¸¸ç³»: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯500ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™

**POST /api/notebooks** - ãƒãƒ¼ãƒˆä½œæˆ
- âœ… æ­£å¸¸ç³»: æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã§æ–°ã—ã„ãƒãƒ¼ãƒˆã‚’ä½œæˆ
- âœ… æ­£å¸¸ç³»: descriptionãŒnullã®å ´åˆã§ã‚‚ä½œæˆå¯èƒ½
- âœ… æ­£å¸¸ç³»: tagsãŒç©ºé…åˆ—ã®å ´åˆã§ã‚‚ä½œæˆå¯èƒ½
- âœ… ç•°å¸¸ç³»: titleãŒç©ºã®å ´åˆã¯400ã‚¨ãƒ©ãƒ¼
- âœ… ç•°å¸¸ç³»: titleãŒ101æ–‡å­—ä»¥ä¸Šã®å ´åˆã¯400ã‚¨ãƒ©ãƒ¼
- âœ… ç•°å¸¸ç³»: descriptionãŒ501æ–‡å­—ä»¥ä¸Šã®å ´åˆã¯400ã‚¨ãƒ©ãƒ¼
- âœ… ç•°å¸¸ç³»: tagsãŒ21å€‹ä»¥ä¸Šã®å ´åˆã¯400ã‚¨ãƒ©ãƒ¼
- âœ… ç•°å¸¸ç³»: tagãŒ21æ–‡å­—ä»¥ä¸Šã®å ´åˆã¯400ã‚¨ãƒ©ãƒ¼
- âœ… ç•°å¸¸ç³»: ä¸æ­£ãªJSONã®å ´åˆã¯400ã‚¨ãƒ©ãƒ¼
- âœ… ç•°å¸¸ç³»: æœªèªè¨¼ã®å ´åˆã¯401ã‚¨ãƒ©ãƒ¼
- âœ… ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹: titleãŒ1æ–‡å­—ã§ã‚‚ä½œæˆå¯èƒ½
- âœ… ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹: titleãŒ100æ–‡å­—ã§ã‚‚ä½œæˆå¯èƒ½
- âœ… ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹: tagsãŒ20å€‹ã§ã‚‚ä½œæˆå¯èƒ½

### /api/notebooks/[id] ([id]/route.ts)

**GET /api/notebooks/[id]** - å€‹åˆ¥ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å–å¾—
- âœ… æ­£å¸¸ç³»: æŒ‡å®šã•ã‚ŒãŸIDã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’è¿”ã™
- âœ… ç•°å¸¸ç³»: æœªèªè¨¼ã®å ´åˆã¯401ã‚¨ãƒ©ãƒ¼
- âœ… ç•°å¸¸ç³»: å­˜åœ¨ã—ãªã„ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®å ´åˆã¯404ã‚¨ãƒ©ãƒ¼
- âœ… ç•°å¸¸ç³»: ä»–äººã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆã¯ã‚¨ãƒ©ãƒ¼

**PUT /api/notebooks/[id]** - ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯æ›´æ–°
- âœ… æ­£å¸¸ç³»: æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã§ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’æ›´æ–°
- âœ… æ­£å¸¸ç³»: ä¸€éƒ¨ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿æ›´æ–°å¯èƒ½
- âœ… æ­£å¸¸ç³»: ç©ºã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã§ã‚‚å‡¦ç†å¯èƒ½
- âœ… ç•°å¸¸ç³»: titleãŒç©ºæ–‡å­—ã®å ´åˆã¯400ã‚¨ãƒ©ãƒ¼
- âœ… ç•°å¸¸ç³»: titleãŒ101æ–‡å­—ä»¥ä¸Šã®å ´åˆã¯400ã‚¨ãƒ©ãƒ¼
- âœ… ç•°å¸¸ç³»: descriptionãŒ501æ–‡å­—ä»¥ä¸Šã®å ´åˆã¯400ã‚¨ãƒ©ãƒ¼
- âœ… ç•°å¸¸ç³»: tagsãŒ21å€‹ä»¥ä¸Šã®å ´åˆã¯400ã‚¨ãƒ©ãƒ¼
- âœ… ç•°å¸¸ç³»: æœªèªè¨¼ã®å ´åˆã¯401ã‚¨ãƒ©ãƒ¼
- âœ… ç•°å¸¸ç³»: å­˜åœ¨ã—ãªã„ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼

**DELETE /api/notebooks/[id]** - ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å‰Šé™¤
- âœ… æ­£å¸¸ç³»: æŒ‡å®šã•ã‚ŒãŸIDã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å‰Šé™¤
- âœ… ç•°å¸¸ç³»: æœªèªè¨¼ã®å ´åˆã¯401ã‚¨ãƒ©ãƒ¼
- âœ… ç•°å¸¸ç³»: å­˜åœ¨ã—ãªã„ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®å ´åˆã¯404ã‚¨ãƒ©ãƒ¼
- âœ… ç•°å¸¸ç³»: ä»–äººã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å‰Šé™¤ã—ã‚ˆã†ã¨ã—ãŸå ´åˆã¯404ã‚¨ãƒ©ãƒ¼

**åˆè¨ˆ**: 37ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆã®æ›¸ãæ–¹

### åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { createMockRequest, expectSuccessResponse } from '@/tests/helpers/api.helper';

describe('API Endpoint', () => {
  beforeEach(() => {
    // ãƒ¢ãƒƒã‚¯ã®ãƒªã‚»ãƒƒãƒˆ
  });

  it('should do something', async () => {
    // Arrange: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
    const request = createMockRequest({
      method: 'POST',
      body: { title: 'Test' },
      userId: 'user-123',
    });

    // Act: ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®å®Ÿè¡Œ
    const response = await POST(request);

    // Assert: çµæœã®æ¤œè¨¼
    expect(response.status).toBe(201);
    const data = await expectSuccessResponse(response, 201);
    expect(data).toHaveProperty('notebook');
  });
});
```

### ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã®ä½¿ç”¨

```typescript
// ãƒ¢ãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä½œæˆ
const request = createMockRequest({
  method: 'POST',
  url: 'http://localhost:3000/api/notebooks',
  body: { title: 'Test' },
  userId: 'user-123',
  headers: { 'X-Custom': 'value' },
  searchParams: { page: '1' },
});

// æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¤œè¨¼
const data = await expectSuccessResponse<{ notebook: Notebook }>(
  response,
  201 // æœŸå¾…ã™ã‚‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰
);

// ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¤œè¨¼
await expectErrorResponse(
  response,
  'AUTHENTICATION_FAILED', // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰
  401 // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰
);

// ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®æ¤œè¨¼
await expectValidationError(
  response,
  'title' // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
);
```

### ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ã®ä½¿ç”¨

```typescript
import {
  createMockNotebook,
  createMockNotebooks,
  createMockNotebookWithPages,
  createNotebookRequestBody,
} from '@/tests/factories/notebook.factory';

// å˜ä¸€ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯
const notebook = createMockNotebook({
  title: 'Custom Title',
  ownerId: 'user-123',
});

// è¤‡æ•°ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯
const notebooks = createMockNotebooks(5, {
  ownerId: 'user-123',
});

// ãƒšãƒ¼ã‚¸ä»˜ããƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯
const notebookWithPages = createMockNotebookWithPages(3, {
  title: 'Notebook with 3 pages',
});

// ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£
const requestBody = createNotebookRequestBody({
  title: 'New Notebook',
  tags: ['test'],
});
```

---

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹å ´åˆ

1. **ãƒ¢ãƒƒã‚¯ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª**
   ```typescript
   vi.mock('@/services/noteService', () => ({
     noteService: mockNoteService,
   }));
   ```

2. **beforeEachã§ãƒ¢ãƒƒã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆ**
   ```typescript
   beforeEach(() => {
     resetNoteServiceMocks();
     resetAuthMock();
   });
   ```

3. **éåŒæœŸå‡¦ç†ã‚’æ­£ã—ãå¾…æ©Ÿ**
   ```typescript
   const response = await GET(request); // await ã‚’å¿˜ã‚Œãšã«
   ```

### ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼

**"Cannot read property 'json' of undefined"**
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæ­£ã—ãè¿”ã•ã‚Œã¦ã„ãªã„
- ãƒ¢ãƒƒã‚¯ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ãªã„

**"Expected 201 to be 400"**
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒæœŸå¾…é€šã‚Šã«å‹•ä½œã—ã¦ã„ãªã„
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®å½¢å¼ã‚’ç¢ºèª

**"Mock function not called"**
- ãƒ¢ãƒƒã‚¯ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ãªã„
- æ¡ä»¶åˆ†å²ã§æœŸå¾…ã™ã‚‹ãƒ‘ã‚¹ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„

---

## ğŸ“ˆ ä»Šå¾Œã®æ”¹å–„

- [ ] E2Eãƒ†ã‚¹ãƒˆã®è¿½åŠ ï¼ˆPlaywrightï¼‰
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã®è¿½åŠ 
- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Šã‚’ç›®æ¨™
- [ ] CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¸ã®çµ±åˆ
- [ ] ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®æ¤œè¨

---

## ğŸ¤ è²¢çŒ®

æ–°ã—ã„ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã™ã‚‹éš›ã¯ã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

1. âœ… æ­£å¸¸ç³»ã€ç•°å¸¸ç³»ã€ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã‚’ã‚«ãƒãƒ¼
2. âœ… Arrange-Act-Assert ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨
3. âœ… æ˜ç¢ºãªãƒ†ã‚¹ãƒˆåï¼ˆä½•ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã‹ï¼‰
4. âœ… ãƒ¢ãƒƒã‚¯ã‚’é©åˆ‡ã«ãƒªã‚»ãƒƒãƒˆ
5. âœ… ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’æ´»ç”¨

---

**ä½œæˆæ—¥**: 2025-10-24  
**æœ€çµ‚æ›´æ–°**: 2025-10-24  
**ãƒ¡ãƒ³ãƒ†ãƒŠãƒ¼**: Schoolverse Development Team
